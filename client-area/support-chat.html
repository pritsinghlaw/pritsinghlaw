<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Legal Assistant</title>
    <!-- Use Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Branding colors from pritsinghlaw.com */
            --brand-blue: #001f54;
            --brand-gold: #ff4900;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Light slate gray */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #chat-container {
            max-height: 90vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Hide the scrollbar for a cleaner look */
        #chat-container::-webkit-scrollbar {
            display: none;
        }

        /* Custom scrollbar for Firefox */
        #chat-container {
            scrollbar-width: none;
        }

        .user-message {
            background-color: var(--brand-blue);
            color: white;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-top-left-radius: 1rem;
        }

        .bot-message {
            background-color: var(--brand-gold);
            color: var(--brand-blue);
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        /* Animation for message entry */
        .message-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-animation {
            animation: pulse-ring 1.5s cubic-bezier(0.2, 0, 0, 1) infinite;
        }
        
        .dot {
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.85);
                opacity: 1;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Chatbot Main Container -->
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-lg mx-4 md:mx-auto lg:max-w-xl flex flex-col h-[90vh]">
        
        <!-- Chatbot Header -->
        <header class="bg-white border-b-2 border-gray-100 p-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <!-- Company Logo Placeholder -->
                <img src="/whitenobg.svg" alt="Pritpal Singh Law Logo" class="w-24 h-auto rounded-lg">
                <h1 class="text-xl font-bold text-gray-800">AI Legal Assistant</h1>
            </div>
            <p class="text-sm text-gray-500 hidden md:block">Your Virtual Legal Assistant</p>
        </header>

        <!-- Chat Messages Container -->
        <div id="chat-container" class="flex-grow p-4 space-y-4">
            <!-- Initial greeting message -->
            <div class="flex items-start space-x-2">
                <div class="w-8 h-8 rounded-full bg-brand-gold flex-shrink-0 flex items-center justify-center font-bold text-white">Bot</div>
                <div class="bot-message p-4 text-sm max-w-[80%] shadow-md message-fade-in">
                    <p>Hello! I am your AI Legal Assistant for the Law Offices of Pritpal Singh. How can I assist you with your real estate legal questions today?</p>
                </div>
            </div>
        </div>

        <!-- Chat Input and Action Bar -->
        <div class="p-4 bg-white border-t-2 border-gray-100 flex items-center space-x-2">
            <input type="text" id="user-input" placeholder="Type your message..." class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-gold transition-all duration-200">
            
            <!-- Microphone button -->
            <button id="mic-btn" class="relative p-3 bg-brand-blue text-white rounded-full shadow-lg hover:bg-opacity-90 transition-all duration-200 flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 1 0 0-12a6 6 0 0 0 0 12Zm0 0v3.75m-6.75-3.75H6a.75.75 0 0 1 .75-.75h6.75a.75.75 0 0 1 .75.75h-.75M12 18.75V12a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 .75.75v3.75" />
                </svg>
            </button>

            <!-- Send button -->
            <button id="send-btn" class="p-3 bg-brand-gold text-white rounded-full shadow-lg hover:bg-opacity-90 transition-all duration-200 flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.493 12a59.769 59.769 0 0 1-18.224 8.875L6 12Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            </button>
        </div>
        
        <!-- Footer -->
        <footer class="p-4 bg-gray-50 border-t-2 border-gray-100 text-center text-xs text-gray-400">
            <p class="mb-1">
                This chatbot provides general information and is not a substitute for legal advice.
                The use of this chatbot does not create an attorney-client relationship.
            </p>
            <p>&copy; 2025 Law Offices of Pritpal Singh. All rights reserved.</p>
        </footer>
    </div>
    
    <!-- JavaScript Section -->
    <script>
        // Check for SpeechRecognition support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');

        // Check if `SpeechRecognition` is supported
        const isSpeechRecognitionSupported = !!SpeechRecognition;
        if (!isSpeechRecognitionSupported) {
            micBtn.style.display = 'none'; // Hide the microphone button if not supported
            console.warn("Speech Recognition is not supported in this browser.");
        }
        
        // Define the chatbot's system instructions. This is the "brain" of the chatbot.
        // It's crucial for setting the persona, knowledge base, and rules.
        const systemInstructions = `
            You are an intuitive client support chatbot for a real estate law firm based in the state of California,
            designed to serve as a knowledgeable and helpful virtual assistant for website visitors engaging with the Law Offices of Pritpal Singh.

            Answer general real estate law questions relevant to California, and provide accurate, up-to-date information about the firm, its team,
            especially lead attorney Pritpal Singh (profile at https://www.pritsinghlaw.com/team/pritpal-singh),
            areas of practice (see https://www.pritsinghlaw.com/services), contact details, consultation options, and billing procedures.

            Whenever you respond, first reason through the user’s question or concern step by step. Only after thoroughly considering all aspects,
            produce a clear, concise, and accurate answer that addresses the user’s needs.

            Persist in clarifying the user’s requests if any necessary information is unclear or missing.
            Think step-by-step before composing your reply. Ensure you never provide legal advice, but only general legal information and firm-specific details.

            Details to Incorporate:
            - About the Firm: Provide a well-rounded understanding of the Law Offices of Pritpal Singh, including its history, values, achievements,
            contact info, and areas of practice. Refer to all relevant pages at https://www.pritsinghlaw.com for details.

            - Attorney Profile: Accurately respond to questions about Pritpal Singh, using details from https://www.pritsinghlaw.com/team/pritpal-singh.

            - Consultation Options: Advise clients about:
            1) Free 15-minute phone or Zoom consultations
            2) Paid 1-hour consultations for $500, in person or via Zoom
            Refer to our dedicated booking form at https://www.pritsinghlaw.com/client-area/intake-form

            - Contact Details: Share basic details (address, phone number, email, social media) as per the firm’s website
            (see https://www.pritsinghlaw.com for details). The phone number is (510) 225-9220 and email is info@pritsinghlaw.com.

            - Billing Instructions: Provide clear steps for paying through our secure payment portal powered by LawPay, our preferred payment provider
            which supports credit/debit card payments, echecks and payment plans through Affirm (subject to credit check) or, upon request, via our dedicated Stripe Checkout page.
            Clarify the payment process if users have questions. The payment portal is at https://pritsinghlaw.com/client-area/pay-my-bill.

            Output Format:
            - Begin with a friendly response like “Thanks for your query, followed by the answer”.
            - Use clear, professional and respectful language suitable for a legal services website.
            - Keep answers concise (1–3 paragraphs); break down longer answers for clarity.
            - If a user asks a question not explicitly covered in the provided details, acknowledge the limits of your knowledge and refer them to
            contact the firm’s legal assistant, Michael, directly for more information (refer them to Michael’s profile page at https://pritsinghlaw.com/team/michael-chigbu),
            or call the office at (510) 225-9220 during working hours or send an email to info@pritsinghlaw.com.

            ### Example 1:
            **User Input:** How can I pay my bill?
            **Expected Output:**
            - Reasoning: First, I identify the payment options available as mentioned in the firm instructions: LawPay via the payment portal, or Stripe by request.
            I will clarify the user should use the payment portal for LawPay, or contact us for Stripe. I must provide clear, step-by-step instructions for both methods.
            - Conclusion: You can pay your bill using our dedicated payment portal via LawPay. Please visit https://pritsinghlaw.com/client-area/pay-my-bill
            and follow the prompts to complete your payment securely. If you have any issues with this payment method or prefer to pay via Stripe,
            please let us know and we will send you a Stripe payment link.

            ### Example 2:
            **User Input:** How can I schedule a consultation?
            **Expected Output:**
            - Reasoning: I need to outline the different consultation options: free 15-minute (phone or Zoom) or paid 1-hour ($500, in person or remote). I should explain how to book these sessions.
            - Conclusion: We offer free 15-minute consultations by phone or Zoom, and paid 1-hour consultations for $500, which can be held remotely or in person.
            To schedule, please call us at (510) 225-9220, email us at info@pritsinghlaw.com, or use the online booking form on our website to get started.

            ## Important Reminders:
            - **Do not provide legal advice**; offer only general legal information and firm-specific details.
            - Ensure factual accuracy regarding the firm’s staff, services (refer to https://pritsinghlaw.com/services for all information pertaining to our services and areas of practice), and procedures as per www.pritsinghlaw.com.
            - Never reveal any confidential or private information.
            `;

        let chatHistory = [];
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;

        // Function to create a chat message element
        function createMessageElement(text, isUser = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            messageWrapper.classList.add('message-fade-in');

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-4 rounded-3xl max-w-[80%] shadow-md text-sm transition-all duration-200 ${isUser ? 'user-message' : 'bot-message'}`;
            messageBubble.innerHTML = `<p>${text}</p>`;

            messageWrapper.appendChild(messageBubble);

            if (!isUser) {
                // Add an audio button for bot messages
                const audioBtn = document.createElement('button');
                audioBtn.className = 'ml-2 p-2 rounded-full text-brand-blue hover:text-white hover:bg-brand-blue transition-colors duration-200';
                audioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.924a6.452 6.452 0 0 1 0 12.152M16.514 8.524a2.91 2.91 0 0 1 0 5.852M12 21a9 9 0 1 1 0-18a9 9 0 0 1 0 18ZM15 12a3 3 0 1 1-6 0a3 3 0 0 1 6 0Z" />
                                    </svg>`;
                audioBtn.title = "Listen to message";
                audioBtn.addEventListener('click', () => speakMessage(text));
                messageWrapper.appendChild(audioBtn);
            }

            return messageWrapper;
        }
        
        // Function to display the user's message
        function displayUserMessage(message) {
            const messageElement = createMessageElement(message, true);
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Function to display the bot's message
        function displayBotMessage(message) {
            const messageElement = createMessageElement(message, false);
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Function to display the typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'flex items-center space-x-2';
            typingIndicator.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-brand-gold flex-shrink-0 flex items-center justify-center font-bold text-white">Bot</div>
                <div class="bot-message p-4 max-w-[80%] shadow-md flex space-x-1">
                    <span class="dot w-2 h-2 bg-gray-600 rounded-full"></span>
                    <span class="dot w-2 h-2 bg-gray-600 rounded-full"></span>
                    <span class="dot w-2 h-2 bg-gray-600 rounded-full"></span>
                </div>
            `;
            chatContainer.appendChild(typingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Function to remove the typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Function to handle sending a message
        async function sendMessage(prompt) {
            if (!prompt.trim()) return;

            // Display user message
            displayUserMessage(prompt);
            userInput.value = '';

            // Add user message to chat history
            chatHistory.push({ role: 'user', parts: [{ text: prompt }] });

            // Show typing indicator
            showTypingIndicator();

            try {
                // The API key is provided by the runtime environment.
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: systemInstructions + prompt }] }]
                };
                
                let response;
                let retryCount = 0;
                const maxRetries = 3;
                let delay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            retryCount++;
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`API error: ${response.statusText}`);
                        }

                        const result = await response.json();
                        const botText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (botText) {
                            hideTypingIndicator();
                            displayBotMessage(botText);
                            // Speak the message after displaying it
                            speakMessage(botText);
                            chatHistory.push({ role: 'model', parts: [{ text: botText }] });
                        } else {
                            hideTypingIndicator();
                            displayBotMessage("I'm sorry, I couldn't generate a response. Please try again.");
                        }
                        break; // Exit the loop on success
                    } catch (error) {
                        console.error('API call failed:', error);
                        if (retryCount >= maxRetries - 1) {
                            hideTypingIndicator();
                            displayBotMessage("I'm sorry, I couldn't reach the server. Please try again later.");
                        }
                        retryCount++;
                        delay *= 2; // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (e) {
                hideTypingIndicator();
                console.error('Error during fetch:', e);
                displayBotMessage("I'm sorry, an unexpected error occurred. Please try again.");
            }
        }

        // Event listener for the send button
        sendBtn.addEventListener('click', () => {
            sendMessage(userInput.value);
        });

        // Event listener for the enter key
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage(userInput.value);
            }
        });

        // Function to speak a message using Web Speech API
        function speakMessage(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1; // Default rate
            utterance.pitch = 1; // Default pitch
            speechSynth.speak(utterance);
        }

        // Speech Recognition functionality
        if (isSpeechRecognitionSupported) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Stop after one phrase
            recognition.lang = 'en-US';
            recognition.interimResults = false; // Only return final results
            recognition.maxAlternatives = 1; // The most likely result

            // Event listener for the microphone button
            micBtn.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                    isListening = false;
                    micBtn.classList.remove('pulse-animation');
                } else {
                    recognition.start();
                    isListening = true;
                    micBtn.classList.add('pulse-animation');
                    userInput.placeholder = "Listening...";
                    userInput.disabled = true;
                }
            });

            // Event handler for when speech is recognized
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                isListening = false;
                micBtn.classList.remove('pulse-animation');
                userInput.placeholder = "Type your message...";
                userInput.disabled = false;
                sendMessage(transcript);
            };

            // Event handler for when recognition ends
            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('pulse-animation');
                userInput.placeholder = "Type your message...";
                userInput.disabled = false;
            };

            // Event handler for errors
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                micBtn.classList.remove('pulse-animation');
                userInput.placeholder = "Type your message...";
                userInput.disabled = false;
                displayBotMessage("Sorry, I couldn't hear you. Can you please type your message?");
            };
        }
    </script>
</body>
</html>